# Google Apps Script（GAS）連携セットアップガイド

このガイドでは、Google Apps Scriptを使用して梨花祭2026のスプレッドシートをWebアプリケーションとして公開し、サイトから企画情報をリアルタイムで取得する方法を説明します。

## ステップ1: スプレッドシートの準備

### 1-1. スプレッドシートを作成

1. [Google Drive](https://drive.google.com) にアクセス
2. 「新規」→「スプレッドシート」をクリック
3. スプレッドシートに名前を付ける（例: 「梨花祭2026企画情報」）

### 1-2. ヘッダー行を設定

スプレッドシートの1行目に以下のヘッダーを入力します：

| A | B | C | D | E | F | G | H | I | J | K | L | M | N |
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
| id | type | title | organizer | description | location | day1_start | day1_end | day2_start | day2_end | images | tags | is_food_sold_out | menu_items |

### 1-3. データを入力

2行目以降に企画情報を入力します：

**例:**
```
class-1a | class | 1年A組 お化け屋敷 | 1年A組 | 暗闇の中で繰り広げられる恐怖体験 | 1階 1-A教室 | 10:00 | 16:00 | 10:00 | 16:00 | | 体験型,スリル | FALSE |
```

**各列の説明:**
- **id**: 企画の一意識別子（例: class-1a）
- **type**: 企画の種類（class / club / food）
- **title**: 企画名
- **organizer**: 主催者名（クラス名または部活名）
- **description**: 企画の説明
- **location**: 開催場所
- **day1_start**: 1日目（7/18）開始時刻（HH:MM形式）
- **day1_end**: 1日目終了時刻
- **day2_start**: 2日目（7/19）開始時刻
- **day2_end**: 2日目終了時刻
- **images**: 画像URL（複数の場合はカンマ区切り）
- **tags**: タグ（複数の場合はカンマ区切り）
- **is_food_sold_out**: 飲食企画の売り切れ状態（TRUE/FALSE）
- **menu_items**: メニュー項目（JSON形式）

**menu_items の例:**
```json
[{"name":"たこ焼き（6個）","price":300,"isSoldOut":false},{"name":"たこ焼き（10個）","price":500,"isSoldOut":false}]
```

## ステップ2: Google Apps Scriptの設定

### 2-1. Apps Scriptエディタを開く

1. スプレッドシートを開いた状態で、メニューから「拡張機能」→「Apps Script」をクリック
2. 新しいタブでApps Scriptエディタが開きます

### 2-2. コードを貼り付け

1. エディタの左側にある「Code.gs」をクリック
2. 既存のコードをすべて削除
3. プロジェクトルート内の `GAS_SCRIPT.gs` ファイルの内容をコピー＆ペースト
4. 保存（Ctrl+S または Cmd+S）

### 2-3. デプロイ

1. エディタ上部の「デプロイ」ボタンをクリック
2. 「新しいデプロイ」を選択
3. 右上の歯車アイコンをクリックして「ウェブアプリ」を選択
4. 以下の設定を確認：
   - **実行者**: 自分のアカウント
   - **アクセス**: 全員（匿名ユーザーを含む）
5. 「デプロイ」をクリック
6. 確認ダイアログが表示されたら「許可」をクリック

### 2-4. デプロイURLを取得

1. デプロイ完了後、「デプロイID」の横にあるコピーアイコンをクリック
2. URLが以下の形式で表示されます：
   ```
   https://script.google.com/macros/d/{DEPLOYMENT_ID}/usercontent
   ```

## ステップ3: サイトの環境変数を設定

1. 梨花祭サイトの管理UIを開く
2. 「設定」→「シークレット」をクリック
3. 新しいシークレット「VITE_GAS_DEPLOYMENT_URL」を追加
4. ステップ2-4で取得したURLを貼り付け
5. 保存

## ステップ4: 動作確認

1. サイトの「企画紹介」ページを開く
2. スプレッドシートのデータが表示されることを確認
3. スプレッドシートを編集して保存
4. サイトをリロード（5分以内にキャッシュが更新される）
5. 新しいデータが反映されることを確認

## トラブルシューティング

### データが表示されない場合

1. **GAS URLが正しく設定されているか確認**
   - 管理UIの「シークレット」でURLを確認
   - URLの末尾に余分なスペースがないか確認

2. **スプレッドシートのシート名を確認**
   - GAS_SCRIPT.gs の `SHEET_NAME` が「Programs」になっているか確認
   - スプレッドシートの実際のシート名と一致しているか確認

3. **GASのデプロイを確認**
   - Apps Script エディタで「デプロイ」→「デプロイを管理」を開く
   - 最新のデプロイが表示されているか確認
   - 必要に応じて新しいバージョンをデプロイ

4. **ブラウザコンソールでエラーを確認**
   - F12キーを押して開発者ツールを開く
   - 「コンソール」タブでエラーメッセージを確認

### CORS エラーが表示される場合

1. GAS のデプロイ設定を確認
2. 「アクセス」が「全員（匿名ユーザーを含む）」に設定されているか確認
3. 必要に応じてデプロイを削除して、新しくデプロイ

## データ更新の流れ

1. **スプレッドシートを編集** → 生徒会メンバーが企画情報を追加・編集
2. **自動キャッシュ更新** → 5分ごとにサイトが最新データを取得
3. **サイトに反映** → 来場者が最新の企画情報を確認

## セキュリティに関する注意

- スプレッドシートは「リンクを知っている全員が閲覧可」に設定してください
- 編集権限は生徒会メンバーのみに限定してください
- 個人情報（連絡先など）をスプレッドシートに入力しないでください
